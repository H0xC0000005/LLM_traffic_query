# LLM_query_template.yaml
version: 1

# definitions of placeholders to substitute.
placeholders:
  # details: generated by third party scripts
  rules: |-
    Here are the important and brief rules to follow strictly as you are unable to reason in a sound way:
    - Analyze traffic scenarios and classify them into one of three traffic phase classes: free flow, synchronized flow, or wide moving jam due to three-phase traffic theory.
    - Consider speed, density, inter-vehicle distances as important factors in your analysis.
    - Provide your analysis in yaml format with classification and reasons.
    - Ensure each reason is concise (no more than 20 words) and clearly justifies your classification.
    - Use only ASCII characters in your response.
  reconsider: >-
    Please reconsider the previous traffic scenario and provide your answer
    in the same instructed markdown format.
  prior_knowledge: |-
    - Traffic phases include: free flow, synchronized flow, wide moving jam.
    - Free flow: vehicles can travel at desired speeds with minimal interaction.
    - Synchronized flow: vehicles adjust speeds to match surrounding traffic, leading to reduced speeds and increased density.
    - Wide moving jam: characterized by a dense cluster of slow or stopped vehicles that propagate backward through traffic.
    - Key factors: vehicle speeds, headways, density, flow rates.
    - Analyze speed variations, vehicle interactions, and traffic density patterns over time.
    - The scenes are captured from a bird's-eye view, with the ego vehicle at the center bottom, on autobahn-like roads without intersections.
    - There is no speed limit in all cases, but private vehicles typically travel between 100-150 km/h in free flow conditions.
    - There are no traffic control devices (e.g., traffic lights, stop signs) in these scenarios, and lane changes are infrequent.

initialization_prompt:
  base: |-
    You are a traffic scenario analyst. Your task is to analyze traffic scenarios
    and classify them according to three-phase traffic theory. Or in other words, you should classify the traffic
    scenarios into one of the following traffic phase classes: free flow, synchronized flow, or wide moving jam.
    Speed, density, inter-vehicle distances are important factors to consider in your analysis.
    Here are some prior knowledge and tips, just for recap and emphasis:
    {{ prior_knowledge }}

    All scenarios that I will send you are captured from a bird's-eye view, and the road has the following lane configuration:
    {{ road_config.yaml }}

    Here are three examples to illustrate the classification criteria:
    Example 1:
    {{free_flow_example->vehicles}}
    Example 1 is characterized by vehicles traveling at high speeds with minimal interaction,
    indicating a free flow traffic phase.

    Example 2:
    {{synchronized_flow_example->vehicles}}
    Example 2 shows vehicles adjusting their speeds to match surrounding traffic,
    leading to reduced speeds and increased density. There is also no jammed block and stalled vehicles, indicative of synchronized flow. 

    Example 3:
    {{wide_moving_jam_example->vehicles}}
    Example 3 features a dense cluster of slow or stopped vehicles that propagate backward through traffic.
    There are a few vehicles driving with relatively high speeds ahead of the jammed block, which are detached from the jamming block behind. This is
    characteristic of a wide moving jam traffic phase. 

    For each scenario, provide your analysis in yaml format. You should substitute
    elements in angled brackets with your understanding of bracketed item. Your answer should only contain characters from ASCII set.
    Here is the designated format:

    ```yaml
    result:
      key_observations: 
        - <observation_1>
        - <observation_2>
        - ...
      reasoning_points_from_key_observations_to_classification:
        - <reasoning_point_1>
        - <reasoning_point_2>
        - ...
      classification: <traffic_phase_class>
    ```
    Where <traffic_phase_class> is one of: free flow, synchronized flow, wide moving jam.
    The observations should highlight important traffic characteristics observed in the scenario which are important for classification, 
    and in bullet point and concise (no more than 20 words).
    The reasons should clearly justify how to find the reasonable classification based on the traffic characteristics observed in the scenario, and each item
    should be concise (no more than 20 words).
    Make sure your analysis is thorough and your classification is well-justified.

    I will provide you with one traffic scenario at a time for you to analyze.
    If you understand your task, please acknowledge by stating "Ready to analyze traffic scenarios."


query_prompt:
  templates:
    base: |-
      Here is a traffic scenario to analyze.
      Analyze the traffic scenario carefully and classify it as a traffic phase class according to the rules below.
      Remember that you should provide your answer in the instructed yaml format.

      Traffic Scenario:
      ```yaml
      {{ scenario.vehicles }}
      ```

      Here is a short summary of statistics about the scenario:
      ```yaml
      {{ scene_stats }}
      ```

response_prompt:
  templates:
    good: |-
      Your previous analysis is correct and sound.
      Now here is the next traffic scenario for you to analyze.
      You should analyze it carefully with the same task and provide your answer
      in the same designated markdown format.
      {{ query }}

    incomplete: |-
      Your previous analysis is mostly correct, but you missed some important points.
      Specifically: {{ details }}.
      {{ reconsider }}

    bad_result: |-
      Your previous analysis is sound, but had mistakes in the final classification.
      Specifically: {{ details }}.
      {{ reconsider }}

    incomplete_reasoning: |-
      Your previous analysis contained sound reasoning but was incomplete.
      Specifically: {{ details }}.
      {{ reconsider }}

    bad_reasoning: |-
      Your previous analysis had mistakes in reasoning.
      Specifically: {{ details }}.
      I would like to re-emphasize the rules and tasks: {{ rules }}.
      First, briefly list the reasoning mistakes or deviations from the designated tasks in your previous answer. You should list it as a yaml item:
      ```yaml
      reasoning_mistakes:
        - <mistake_1>
        - <mistake_2>
        - ...
      ```
      Then, {{ reconsider }}
